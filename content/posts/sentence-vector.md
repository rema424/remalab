---
title: 【2020年11月版】PyTorchとBERTで文章の分散表現（ベクトル）を取得する
description: PyTorchでBERTを利用して文章の分散表現（ベクトル）を取得する方法を確認します
date: 2020-11-13T21:13:05+09:00
draft: false
---

日本語における自然言語処理のライブラリ整備がここ1年で大きく進みました。
これに伴って情報の古い記事も多くなったように見受けられたので、今はこんなに簡単になったんだよということで記しておきます。

以前はBERTで日本語を扱う場合は形態素解析やBERTトークン化を自身で行う必要がありましたが、今はライブラリに一任できるようになりました。環境構築も簡単になり非常に扱いやすくなりました。

## setup

```sh
# python3.8のインストール（2020年11月現在、3.9だとエラーになるライブラリが多いため3.8を利用する）
brew install python@3.8

# 仮想環境の作成
python3 -m venv venv

# 仮想環境をアクティベート
. venv/bin/activate

# pipをアップグレード
python -m pip install --upgrade pip

# pytorch（機械学習ライブラリ）のインストール
pip install torch

# transformers（自然言語処理における学習済みモデル提供ライブラリ）のインストール
pip install transformers

# numpy（行列計算ライブラリ）のインストール
pip install numpy

# fugashi（形態素解析器）のインストール
pip install fugashi

# ipadic（形態素解析用辞書）のインストール
pip install ipadic

# mojimoji（日本語文字列の半角・全角変換ライブラリ）のインストール
pip install mojimoji
```

## サンプルコード

```py
import torch
from transformers import BertModel
from transformers.tokenization_bert_japanese import BertJapaneseTokenizer
import re
import mojimoji
import numpy as np
from pprint import pprint as p


# GPUが利用できるか確認
p(torch.cuda.is_available())

# GPUとCPUのどちらを利用するか判定
device = torch.device("cuda:0" if torch.cuda.is_available() else "cpu")
p(device)

# トークナイザーの読み込み
tokenizer = BertJapaneseTokenizer.from_pretrained(
    "cl-tohoku/bert-base-japanese-whole-word-masking"
)

# 学習済みモデルの読み込み
model = BertModel.from_pretrained("cl-tohoku/bert-base-japanese-whole-word-masking")


def preprocess(text):
    """
    日本語文字列の前処理を行う
    """
    # 全角文字を半角に変換
    text = mojimoji.zen_to_han(text)

    # 空白と改行を削除し、コンマとピリオドを句点と読点に変換
    text = (
        text.replace(" ", "")
        .replace("\n", "")
        .replace(",", "、")
        .replace(".", "。")
        .strip()
    )

    # 数字を#に変換
    while bool(re.search(r"[0-9]", text)):
        text = re.sub("[0-9]{5,}", "#####", text)
        text = re.sub("[0-9]{4}", "####", text)
        text = re.sub("[0-9]{3}", "###", text)
        text = re.sub("[0-9]{2}", "##", text)
        text = re.sub("[0-9]{1}", "#", text)

    # 半角文字を全角に変換
    return mojimoji.han_to_zen(text)


def split_to_sentences(text):
    """
    文章を文単位で分割しリストで返却する
    """
    text = re.sub("。", "。\n", text)
    return [s for s in text.split("\n") if s != ""]


def convert_to_single_embedding(embeddings):
    """
    文ベクトルのリストから文章ベクトルを計算する
    """
    return torch.mean(embeddings, dim=0)


def embedding(text):
    # 前処理
    text = preprocess(text)

    # 文単位に分割
    sentences = split_to_sentences(text)

    # BERTトークン化
    encoded = tokenizer.batch_encode_plus(
        sentences, padding=True, add_special_tokens=True
    )

    # BERTトークンID列を抽出
    input_ids = torch.tensor(encoded["input_ids"], device=device)

    # BERTの最大許容トークン数が512なので超える場合は切り詰める
    input_ids = input_ids[:, :512]

    with torch.no_grad():  # 勾配計算なし
        # 単語ベクトルを計算
        outputs = model(input_ids)

    # 最終層の隠れ状態ベクトルを取得
    last_hidden_states = outputs[0]

    # 各文における[CLS]トークンの単語ベクトルを抽出（これを文ベクトルとみなす）
    vecs = last_hidden_states[:, 0, :]

    # 文ベクトルから文章ベクトルを計算
    vec = convert_to_single_embedding(vecs)

    # 保存容量削減のため型変換
    vec = vec.type(torch.float16)

    # データをgpuからcpuに載せ替え
    vec = vec.cpu()

    # numpy配列に変換
    vec = vec.numpy()

    return vec


if __name__ == "__main__":
    text = """
夏目 漱石（なつめ そうせき、1867年2月9日〈慶応3年1月5日〉 - 1916年〈大正5年〉12月9日）は、日本の小説家、評論家、英文学者、俳人。本名は夏目 金之助（なつめ きんのすけ）。俳号は愚陀仏。明治末期から大正初期にかけて活躍した近代日本文学の頂点に立つ作家の一人である。代表作は『吾輩は猫である』『坊っちゃん』『三四郎』『それから』『こゝろ』『明暗』など。明治の文豪として日本の千円紙幣の肖像にもなり、講演録「私の個人主義」も知られている。漱石の私邸に門下生が集った会は木曜会と呼ばれた。
江戸の牛込馬場下横町（現在の東京都新宿区喜久井町）出身。大学時代に正岡子規と出会い、俳句を学ぶ。帝国大学（のちの東京帝国大学、現在の東京大学）英文科卒業後、松山で愛媛県尋常中学校教師、熊本で第五高等学校教授などを務めたあと、イギリスへ留学。帰国後は東京帝国大学講師として英文学を講じ、講義録には『文学論』がある。
講師の傍ら『吾輩は猫である』を雑誌『ホトトギス』に発表。これが評判になり『坊っちゃん』『倫敦塔』などを書く。その後朝日新聞社に入社し、『虞美人草』『三四郎』『それから』などを掲載。当初は余裕派と呼ばれた。「修善寺の大患」後は、『行人』『こゝろ』『道草』などを執筆。「則天去私（そくてんきょし）」の境地に達したといわれる。晩年は胃潰瘍に悩まされ、『明暗』が絶筆となった。
"""

    vec = embedding(text)
    p(vec.shape)
    p(vec.dtype)
    p(vec)
```

## サンプルコードの実行

```sh
$ python main.py

False
device(type='cpu')
(768,)
dtype('float16')
array([-5.4688e-01,  1.4075e-01,  7.9041e-02, -2.6953e-01, -5.0928e-01,
       -1.0242e-01,  1.6895e-01, -2.8857e-01,  7.5562e-02,  9.1553e-01,
       -6.5381e-01,  5.4291e-02, -7.4316e-01, -4.7705e-01,  1.0422e-02,
        8.3154e-01, -2.1167e-01,  3.9368e-02, -2.1436e-01,  5.9717e-01,
       -2.8442e-01,  8.2227e-01, -1.0059e+00,  1.9397e-01, -7.9834e-01,
        3.5278e-01,  1.8774e-01, -8.7463e-02,  1.1841e-01, -8.0444e-02,
       -6.6309e-01,  6.1475e-01, -2.9321e-01, -6.1920e-02,  3.2910e-01,
        7.4707e-01,  1.7859e-01, -2.7124e-01, -5.4932e-01,  2.0850e-01,
        2.3767e-01,  6.2646e-01,  2.5000e-01, -3.1714e-01,  1.4368e-01,
        1.2596e-02,  5.3772e-02, -1.5762e-02,  6.9922e-01, -5.2551e-02,
       -6.6223e-02,  2.2522e-02,  1.4189e+00, -4.7333e-02, -5.6787e-01,
        1.6443e-01, -2.0126e-02, -1.6357e-01, -1.3257e-01, -5.1562e-01,
       -1.7725e-01, -5.4932e-01,  1.4319e-01, -2.7759e-01, -4.9438e-01,
       -2.8613e-01,  2.7676e-03,  3.7939e-01,  1.2588e+00,  1.2439e-01,
       -3.6865e-01, -2.4243e-01,  4.6289e-01, -3.5889e-01, -5.6299e-01,
        8.9035e-03, -3.1885e-01, -8.3691e-01,  1.6003e-03,  1.0137e+00,
       -5.8936e-01,  1.3672e-01, -3.3228e-01, -7.9346e-01, -1.3351e-02,
       -8.2568e-01, -3.7811e-02,  3.0566e-01, -2.4866e-01,  4.4525e-02,
       -1.0266e-01, -2.4219e-01,  3.0579e-02,  3.1030e-01,  8.7256e-01,
        1.2781e-01, -6.3416e-02,  6.9092e-01,  5.0903e-02, -3.3740e-01,
       -1.0968e-01, -9.3066e-01, -1.9873e-01,  3.1226e-01, -7.6367e-01,
       -1.0186e+00,  8.5815e-02, -1.1270e+00,  1.0278e-01,  9.2432e-01,
        2.3364e-01, -5.6366e-02, -3.9478e-01, -1.5015e-01,  1.2512e-01,
        4.7925e-01, -7.0947e-01,  2.9150e-01,  2.7490e-01, -4.1064e-01,
        1.5796e-01, -3.5254e-01,  2.1155e-01, -3.9526e-01,  6.4307e-01,
       -2.8711e-01,  5.2393e-01, -2.6465e-01, -3.6694e-01,  7.3486e-02,
        3.4302e-01, -4.1846e-01, -7.8076e-01,  7.9395e-01,  3.9014e-01,
        2.8296e-01, -4.0039e-02,  5.6885e-01, -8.7109e-01,  2.2876e-01,
        2.4414e-02, -3.1665e-01, -2.6831e-01,  1.2415e-01,  3.2275e-01,
        3.2959e-02, -1.1066e-01,  3.7256e-01,  1.3135e-01,  2.9297e-01,
       -4.4214e-01,  7.2900e-01,  7.2119e-01,  4.5996e-01,  3.5107e-01,
       -3.4937e-01, -4.0918e-01,  9.6826e-01, -4.3274e-02, -5.6006e-01,
        2.8857e-01, -2.8271e-01,  1.4453e-01, -1.0869e+00,  1.5979e-01,
       -3.5181e-01,  9.7021e-01, -2.2424e-01,  7.4585e-02,  3.3618e-01,
        2.9102e-01, -6.3354e-02,  4.0015e-01, -3.4576e-02, -2.2583e-01,
       -8.6914e-01, -1.7456e-01,  1.4368e-01,  3.0014e-02,  1.7834e-01,
        4.2041e-01,  6.1768e-01, -2.4146e-01,  1.6370e-01,  3.9819e-01,
        1.5778e-02,  4.4360e-01, -4.7119e-01,  4.1650e-01,  8.9966e-02,
        3.3154e-01, -1.7371e-01,  6.7578e-01,  4.5532e-01, -1.4832e-01,
       -2.7881e-01,  8.3496e-01, -5.9082e-01, -8.0078e-01,  4.2664e-02,
        3.8892e-01,  2.3056e-02, -8.2959e-01, -7.8906e-01,  1.5002e-01,
        6.9336e-01,  3.6743e-02, -8.3789e-01,  1.1517e-01,  5.1660e-01,
       -3.6060e-01, -9.2139e-01,  2.0752e-01, -1.2286e-01,  4.0283e-01,
       -1.3159e-01, -9.4678e-01, -4.0845e-01,  1.2494e-01, -1.0425e-01,
        6.4209e-01, -7.2412e-01, -6.9336e-01, -2.8418e-01, -3.4644e-01,
        4.6045e-01,  5.7892e-02,  1.1621e-01,  5.8301e-01,  4.6069e-01,
       -8.6816e-01, -4.5703e-01,  6.5186e-01, -5.1300e-02, -2.2363e-01,
       -2.7612e-01,  3.1592e-01, -8.6572e-01,  3.7524e-01, -1.3229e-02,
       -4.5605e-01,  4.4751e-01, -6.5552e-02,  5.8008e-01,  1.4453e-01,
       -1.1029e-01,  1.0205e-01, -1.7493e-01,  1.5503e-01,  5.3613e-01,
        6.8262e-01, -6.9189e-01,  1.6342e-02,  2.3132e-01, -3.0078e-01,
       -2.4841e-01, -2.4170e-01,  2.2644e-02, -1.2047e-02,  1.7212e-01,
       -5.6122e-02, -3.2593e-01, -9.6826e-01, -1.6553e-01, -8.1592e-01,
       -2.4451e-01, -2.2107e-01,  2.1875e-01,  3.4473e-01, -2.9370e-01,
        1.8909e-01,  1.6220e-02,  1.6565e-01,  5.1318e-01, -7.9688e-01,
        3.3936e-01,  1.1836e+00, -1.5247e-01,  9.7021e-01,  1.0938e+00,
        3.0664e-01,  6.7871e-01, -7.2998e-01, -2.6636e-01, -6.8555e-01,
       -6.4014e-01,  1.2793e-01,  5.9174e-02,  5.8411e-02, -1.6333e-01,
        3.5840e-01, -1.9928e-02,  2.8900e-02, -1.5381e-01, -3.4668e-01,
       -6.6016e-01,  1.9196e-02, -9.9365e-02, -4.1284e-01,  4.4922e-01,
       -1.7053e-01, -4.4897e-01,  3.5645e-01,  1.0225e+00, -1.2041e+00,
       -1.5149e-01,  2.5195e-01, -3.1787e-01,  7.2876e-02, -6.7969e-01,
        1.7310e-01,  1.9092e-01,  3.0823e-02, -3.8672e-01,  7.6221e-01,
       -6.1670e-01,  4.3732e-02,  2.3483e-02,  2.1716e-01, -1.0883e-01,
       -3.9429e-01, -1.4514e-01, -1.7444e-01, -4.2999e-02, -5.9619e-01,
        1.1377e+00,  3.2007e-01,  4.5166e-01, -5.6592e-01, -3.8116e-02,
        7.8552e-02,  1.2720e-01,  3.9160e-01,  2.5806e-01,  1.6309e-01,
       -2.9199e-01, -5.6787e-01, -5.8154e-01, -1.1818e-02,  8.5938e-01,
        1.2695e-01,  2.2314e-01,  2.0117e-01, -9.1797e-01,  4.2114e-01,
       -2.2507e-02, -9.3115e-01, -6.7932e-02, -7.4658e-01, -7.4316e-01,
        2.6025e-01, -4.9976e-01, -4.0381e-01, -6.0156e-01,  2.8882e-01,
       -1.5393e-01,  2.0740e-01, -5.9375e-01,  6.1230e-01, -8.3105e-01,
       -5.3345e-02,  6.4258e-01, -5.1416e-01,  4.5361e-01,  9.1064e-01,
        2.2656e-01, -7.7820e-02, -6.2061e-01, -3.1201e-01, -3.1372e-01,
        5.0049e-01, -5.8289e-02,  6.1646e-02, -2.0032e-01, -2.7612e-01,
       -1.8713e-01,  1.1143e+00,  4.8853e-01,  3.9819e-01,  8.3838e-01,
        7.1030e-03, -2.8711e-01, -6.0303e-01, -6.9336e-02,  3.3643e-01,
       -9.8975e-01, -1.0796e-02,  1.4030e-02, -1.5149e-01, -2.6147e-01,
       -1.9287e-01,  6.1084e-01,  4.0454e-01,  2.7026e-01,  8.2703e-02,
       -7.4365e-01,  8.7793e-01, -1.3562e-01,  6.6211e-01, -3.2806e-02,
        1.4441e-01, -4.4824e-01,  2.1521e-01,  1.0370e-01, -1.0175e-01,
        1.6586e-02,  4.8401e-02,  6.0211e-02, -1.9653e-01,  1.4246e-01,
        4.7729e-01,  5.9180e-01, -7.0117e-01,  6.0400e-01, -5.7764e-01,
       -2.0471e-01, -4.1504e-02,  1.3708e-01, -4.4482e-01, -2.3186e-05,
        5.1074e-01, -5.8691e-01,  5.4077e-02, -9.3628e-02,  9.9426e-02,
        9.4336e-01, -1.5759e-01, -5.2490e-01,  5.3680e-02,  3.4332e-02,
       -6.4941e-01, -2.4402e-01,  4.3457e-01, -2.8394e-01,  1.5784e-01,
        2.5439e-01, -7.0068e-01,  1.4624e-01,  2.5513e-02, -2.4731e-01,
       -5.0195e-01, -3.5815e-01,  5.5322e-01,  3.7695e-01, -1.2634e-01,
       -5.0977e-01, -2.0557e-01,  1.7627e-01, -2.8931e-01, -1.3525e-01,
        3.0298e-01,  3.4692e-01, -1.6467e-01, -2.4792e-01,  3.0029e-01,
        1.4478e-01, -4.6484e-01, -2.7808e-01, -2.1753e-01,  3.3740e-01,
        7.0984e-02, -5.6038e-03,  7.2670e-03, -7.8760e-01, -1.9550e-03,
       -2.7686e-01,  7.3926e-01, -5.1562e-01,  6.5674e-01,  4.8193e-01,
       -2.4146e-01, -2.1408e-02, -2.2058e-01,  6.1670e-01, -3.2007e-01,
        8.0078e-01, -1.4004e+00,  9.3701e-01,  2.0361e-01, -3.9111e-01,
        8.2910e-01, -4.4464e-02,  3.5675e-02,  6.7773e-01,  4.6436e-01,
        8.1104e-01,  1.5266e-02, -6.2793e-01, -1.1260e+00,  7.9980e-01,
       -5.0684e-01, -2.3962e-01, -5.8008e-01,  4.8022e-01, -2.6611e-01,
       -3.3496e-01,  3.3008e-01, -2.8149e-01,  3.7793e-01,  3.7769e-01,
       -2.3157e-01,  1.5625e-01,  1.4062e-01, -2.8955e-01, -2.6001e-01,
        3.8013e-01,  2.0227e-01,  3.1177e-01,  1.5198e-01, -1.9702e-01,
       -3.5864e-01, -1.8530e-01, -3.2666e-01, -5.0146e-01, -1.0361e+00,
        2.2119e-01, -2.9272e-01, -9.1016e-01, -4.1211e-01,  2.7051e-01,
       -3.1982e-01, -3.5474e-01,  4.7729e-02,  2.1265e-01, -1.3702e-02,
       -5.0415e-02,  5.0507e-02, -5.3418e-01,  2.3291e-01, -4.1211e-01,
        6.6699e-01,  5.8044e-02,  1.5747e-01, -1.5881e-01,  5.0195e-01,
        1.5845e-01, -7.2403e-03,  9.0430e-01,  2.8003e-01,  4.1309e-01,
       -7.1436e-01, -1.5356e-01,  1.8665e-01,  3.3716e-01, -5.4297e-01,
        1.2512e-01, -1.2708e-01, -4.1016e-01, -7.9541e-01, -2.9028e-01,
       -5.0830e-01, -7.9163e-02,  1.1920e-01,  3.9307e-01, -7.4658e-01,
        5.2930e-01, -2.9175e-01,  1.9800e-01,  2.1777e-01, -4.3915e-02,
        3.5254e-01,  3.6792e-01,  5.9375e-01,  1.7847e-01,  1.9556e-01,
        7.0166e-01,  4.4092e-01,  7.6233e-02, -6.0638e-02,  4.5280e-03,
       -1.1121e-01, -1.4197e-01,  4.1943e-01,  1.1309e+00,  2.8613e-01,
       -3.4937e-01,  4.8065e-02, -1.5430e-01,  6.5234e-01, -1.1641e+00,
        2.3376e-01, -4.0747e-01, -5.0598e-02,  1.4148e-01, -3.1836e-01,
        6.0938e-01,  6.2061e-01,  1.2217e+00, -3.8770e-01,  3.7329e-01,
       -1.4270e-01,  2.7539e-01,  1.9080e-01,  1.0266e-01, -1.1024e-02,
       -7.5684e-01, -1.0876e-01,  2.3633e-01,  3.9600e-01, -3.2617e-01,
        6.0693e-01,  5.8496e-01,  2.0947e-01, -4.9652e-02, -1.2103e-01,
        8.1848e-02,  2.7393e-01,  4.7046e-01,  9.0332e-01, -6.5308e-02,
        5.7764e-01, -1.1963e+00,  2.0386e-01,  2.3145e-01, -5.4004e-01,
       -2.8125e-01,  1.4807e-01,  8.4609e+00,  6.2109e-01,  1.7688e-01,
        9.4971e-02,  5.4932e-01, -9.3311e-01, -2.1484e-01, -1.1292e-01,
       -3.2544e-01,  2.2778e-01, -5.9723e-02, -4.4067e-01, -6.0596e-01,
        4.2725e-01, -4.3945e-01,  6.8457e-01,  1.5833e-01, -1.6815e-02,
        3.9844e-01,  2.5562e-01,  3.9307e-01, -6.8311e-01, -4.6094e-01,
       -4.4971e-01, -6.0547e-01,  9.3311e-01, -5.2734e-01,  9.0039e-01,
        3.1812e-01,  9.3457e-01, -2.2327e-01, -2.1899e-01,  9.3811e-02,
        1.7517e-01,  4.9756e-01,  4.9512e-01,  8.8330e-01,  8.7354e-01,
        1.4673e-01, -1.9482e-01,  1.5466e-01,  2.1576e-02, -4.9957e-02,
        1.9836e-01,  7.1436e-01, -5.2588e-01, -7.4072e-01, -4.6997e-01,
       -1.2054e-01,  3.1934e-01, -7.5073e-02,  2.1631e-01,  1.3984e+00,
       -9.0576e-02, -7.9443e-01, -1.4600e-01, -2.9663e-01, -3.3911e-01,
       -1.4275e-02,  1.0895e-01,  1.8884e-01, -2.2424e-01, -5.1855e-01,
       -2.8052e-01, -2.6074e-01, -9.8682e-01, -8.7070e-04,  5.3369e-01,
       -1.0669e-01,  1.5955e-01,  8.0957e-01,  3.0322e-01, -2.5488e-01,
        8.4424e-01,  8.0664e-01, -1.0293e+00,  5.8057e-01,  3.1433e-02,
       -5.6982e-01,  5.9082e-01,  9.5703e-02,  3.5547e-01, -4.1577e-01,
       -6.2012e-01, -5.7861e-01, -8.9035e-03, -4.6729e-01, -1.1755e-01,
       -1.3574e-01,  4.1699e-01, -7.4280e-02,  7.5488e-01,  6.2744e-01,
        2.6416e-01, -3.5132e-01,  1.1700e-01,  4.9170e-01, -9.2041e-01,
        1.3940e-01,  2.4670e-01,  2.2058e-01,  7.2510e-01, -1.5002e-01,
        3.3472e-01, -4.3262e-01, -4.7150e-02, -5.8252e-01,  2.1130e-01,
       -6.5332e-01,  2.4158e-01, -1.8726e-01, -1.8457e-01,  6.2207e-01,
       -5.4346e-01, -2.9468e-01,  1.2915e-01, -1.8860e-01,  4.5801e-01,
        4.2017e-01,  1.3242e+00, -5.4102e-01,  3.8257e-01, -2.8442e-01,
        3.6768e-01,  3.2764e-01, -3.5156e-01,  4.7668e-02,  5.5408e-04,
       -9.4189e-01, -1.3879e-01,  4.5386e-01, -4.7827e-01, -1.1816e+00,
       -8.3557e-02, -9.7961e-02,  1.0518e+00, -3.6743e-02, -3.5718e-01,
       -8.8672e-01, -1.8799e-01,  1.3843e-01, -2.6196e-01, -5.1971e-02,
        3.7140e-02,  3.7384e-02, -2.2202e-02, -7.2705e-01, -2.5684e-01,
       -3.5034e-01, -1.1826e+00,  4.4891e-02], dtype=float16)
```